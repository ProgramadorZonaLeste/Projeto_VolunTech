import React, { useState, useEffect, createContext, useContext } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    signInAnonymously, 
    signInWithCustomToken, 
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut as firebaseSignOut,
    updateProfile
} from 'firebase/auth';
import { 
    getFirestore, 
    doc, 
    setDoc, 
    getDoc, 
    addDoc, 
    collection, 
    query, 
    where, 
    getDocs,
    Timestamp,
    orderBy,
    updateDoc,
    deleteDoc,
    onSnapshot
} from 'firebase/firestore';
import { setLogLevel } from 'firebase/firestore';

// Import Lucide Icons
import { 
    HeartHandshake, Users, Briefcase, PlusCircle, LogIn, LogOut, UserPlus, Search, 
    MapPin, CalendarDays, ListChecks, UserCircle, Building, Home, MessageSquare, 
    CheckCircle, XCircle, Clock, Edit3, Trash2, Send, Info, Eye, EyeOff, AlertTriangle,
    Award, Star, Filter, ChevronDown, ChevronUp, Settings, Bell, Mail, Quote, Sparkles, Users2,
    ArrowLeft, Ticket, ClipboardSignature, FileText, Globe
} from 'lucide-react';

// Firebase Configuration (to be replaced by __firebase_config in environment)
const firebaseConfigFromEnv = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
const parsedFirebaseConfig = firebaseConfigFromEnv ? JSON.parse(firebaseConfigFromEnv) : {
    apiKey: "YOUR_API_KEY", // Replace if testing locally and not in Canvas
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

const app = initializeApp(parsedFirebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
setLogLevel('debug'); // Firestore logging

const appId = typeof __app_id !== 'undefined' ? __app_id : 'voluntech-app';

// Auth Context
const AuthContext = createContext();
export const useAuth = () => useContext(AuthContext);

export const AuthProvider = ({ children }) => {
    const [currentUser, setCurrentUser] = useState(null);
    const [userData, setUserData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [isAuthReady, setIsAuthReady] = useState(false);

    useEffect(() => {
        const initialAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    if (!auth.currentUser) {
                        // console.log("No current user, attempting anonymous sign-in for initial auth check.");
                        // await signInAnonymously(auth); 
                    }
                }
            } catch (error) {
                console.error("Error during initial auth:", error);
                // await signInAnonymously(auth); 
            }

            const unsubscribe = onAuthStateChanged(auth, async (user) => {
                setCurrentUser(user);
                if (user) {
                    const userDocRef = doc(db, `/artifacts/${appId}/public/data/users/${user.uid}`);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        setUserData({ id: userDocSnap.id, ...userDocSnap.data() });
                    } else {
                        setUserData(null); 
                    }
                } else {
                    setUserData(null);
                }
                setLoading(false);
                setIsAuthReady(true);
            });
            return () => unsubscribe();
        };
        initialAuth();
    }, []);

    const value = {
        currentUser,
        userData,
        loading,
        isAuthReady,
        setUserData, 
    };

    return <AuthContext.Provider value={value}>{!loading && children}</AuthContext.Provider>;
};

// Helper Components
const LoadingSpinner = () => (
    <div className="flex justify-center items-center h-screen">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>
);

const MessageBox = ({ message, type, onDismiss }) => {
    if (!message) return null;
    const bgColor = type === 'error' ? 'bg-red-100 border-red-500 text-red-700' : 
                    type === 'success' ? 'bg-green-100 border-green-500 text-green-700' :
                    'bg-blue-100 border-blue-500 text-blue-700';
    return (
        <div className={`border p-4 rounded-md my-4 ${bgColor} flex justify-between items-center shadow-lg`} role="alert">
            <div className="flex items-center">
                {type === 'error' && <AlertTriangle className="mr-2" />}
                {type === 'success' && <CheckCircle className="mr-2" />}
                {type === 'info' && <Info className="mr-2" />}
                <p>{message}</p>
            </div>
            {onDismiss && (
                <button onClick={onDismiss} className="ml-4 text-lg font-semibold hover:text-opacity-75">
                    &times;
                </button>
            )}
        </div>
    );
};

// Main App Component
function App() {
    const [currentPage, setCurrentPage] = useState('home');
    const [selectedOpportunity, setSelectedOpportunity] = useState(null);
    const [selectedEvent, setSelectedEvent] = useState(null); 
    const [showAuthModal, setShowAuthModal] = useState(false);
    const [authMode, setAuthMode] = useState('login'); 
    const [message, setMessage] = useState({ text: '', type: '' });

    const { currentUser, userData, loading, isAuthReady } = useAuth();

    const handleShowMessage = (text, type, duration = 5000) => {
        setMessage({ text, type });
        if (duration) {
            setTimeout(() => setMessage({ text: '', type: '' }), duration);
        }
    };
    
    const dismissMessage = () => {
        setMessage({ text: '', type: '' });
    };

    const navigate = (page, data = null) => {
        setCurrentPage(page);
        if (page === 'opportunityDetails' && data) {
            setSelectedOpportunity(data);
        }
        if (page === 'eventDetails' && data) {
            setSelectedEvent(data);
        }
        if (page === 'eventRegistration' && data) { 
            setSelectedEvent(data);
        }
        if (page === 'opportunityApplication' && data) { 
            setSelectedOpportunity(data);
        }
        window.scrollTo(0, 0);
    };

    const handleSignOut = async () => {
        try {
            await firebaseSignOut(auth);
            handleShowMessage('Logout realizado com sucesso!', 'success');
            navigate('home');
        } catch (error) {
            console.error("Error signing out:", error);
            handleShowMessage(`Erro ao sair: ${error.message}`, 'error');
        }
    };

    if (loading || !isAuthReady) {
        return <LoadingSpinner />;
    }

    return (
        <div className="min-h-screen bg-gray-100 font-inter flex flex-col">
            <Navbar navigate={navigate} currentUser={currentUser} userData={userData} handleSignOut={handleSignOut} setShowAuthModal={setShowAuthModal} setAuthMode={setAuthMode} />
            <main className="flex-grow container mx-auto px-4 py-8">
                <MessageBox message={message.text} type={message.type} onDismiss={dismissMessage} />
                {currentPage === 'home' && <HomePage navigate={navigate} setShowAuthModal={setShowAuthModal} setAuthMode={setAuthMode} />}
                {currentPage === 'opportunities' && <OpportunitiesPage navigate={navigate} setShowAuthModal={setShowAuthModal} setAuthMode={setAuthMode} handleShowMessage={handleShowMessage}/>}
                {currentPage === 'opportunityDetails' && selectedOpportunity && <OpportunityDetailsPage opportunity={selectedOpportunity} navigate={navigate} />}
                {currentPage === 'volunteerDashboard' && userData?.role === 'volunteer' && <VolunteerDashboard navigate={navigate} />}
                {currentPage === 'organizationDashboard' && userData?.role === 'organization' && <OrganizationDashboard navigate={navigate} />}
                {currentPage === 'profile' && <UserProfilePage navigate={navigate} />}
                {currentPage === 'eventDetails' && selectedEvent && <EventDetailsPage event={selectedEvent} navigate={navigate} />}
                {currentPage === 'eventRegistration' && selectedEvent && <EventRegistrationPage event={selectedEvent} navigate={navigate} handleShowMessage={handleShowMessage}/>}
                {currentPage === 'opportunityApplication' && selectedOpportunity && <OpportunityApplicationPage opportunity={selectedOpportunity} navigate={navigate} handleShowMessage={handleShowMessage} />}
            </main>
            <Footer />
            {showAuthModal && <AuthModal mode={authMode} setMode={setAuthMode} onClose={() => setShowAuthModal(false)} navigate={navigate} handleShowMessage={handleShowMessage} />}
        </div>
    );
}

// Navbar Component
const Navbar = ({ navigate, currentUser, userData, handleSignOut, setShowAuthModal, setAuthMode }) => {
    const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

    return (
        <nav className="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-lg sticky top-0 z-50">
            <div className="container mx-auto px-4">
                <div className="flex items-center justify-between h-16">
                    <div className="flex items-center">
                        <HeartHandshake className="h-8 w-8 mr-2 text-yellow-400" />
                        <span className="text-2xl font-bold cursor-pointer" onClick={() => navigate('home')}>VolunTech</span>
                    </div>
                    <div className="hidden md:flex items-center space-x-4">
                        <NavItem onClick={() => navigate('home')} icon={<Home size={18}/>}>Início</NavItem>
                        <NavItem onClick={() => navigate('opportunities')} icon={<Search size={18}/>}>Oportunidades</NavItem>
                        {currentUser && userData && (
                            <>
                                {userData.role === 'volunteer' && <NavItem onClick={() => navigate('volunteerDashboard')} icon={<UserCircle size={18}/>}>Meu Painel</NavItem>}
                                {userData.role === 'organization' && <NavItem onClick={() => navigate('organizationDashboard')} icon={<Building size={18}/>}>Painel da ONG</NavItem>}
                                <NavItem onClick={() => navigate('profile')} icon={<Settings size={18}/>}>Perfil</NavItem>
                                <button
                                    onClick={handleSignOut}
                                    className="flex items-center px-3 py-2 rounded-md text-sm font-medium hover:bg-indigo-500 transition duration-150"
                                >
                                    <LogOut size={18} className="mr-1" /> Sair
                                </button>
                            </>
                        )}
                        {!currentUser && (
                            <>
                                <button
                                    onClick={() => { setAuthMode('login'); setShowAuthModal(true); }}
                                    className="flex items-center px-3 py-2 rounded-md text-sm font-medium hover:bg-indigo-500 transition duration-150"
                                >
                                    <LogIn size={18} className="mr-1" /> Entrar
                                </button>
                                <button
                                    onClick={() => { setAuthMode('signup'); setShowAuthModal(true); }}
                                    className="flex items-center bg-yellow-400 text-blue-700 px-3 py-2 rounded-md text-sm font-medium hover:bg-yellow-300 transition duration-150"
                                >
                                    <UserPlus size={18} className="mr-1" /> Cadastrar
                                </button>
                            </>
                        )}
                    </div>
                    <div className="md:hidden">
                        <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="text-white focus:outline-none">
                            {isMobileMenuOpen ? <XCircle size={24} /> : <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>}
                        </button>
                    </div>
                </div>
            </div>
            {isMobileMenuOpen && (
                <div className="md:hidden bg-indigo-600">
                    <div className="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                        <MobileNavItem onClick={() => { navigate('home'); setIsMobileMenuOpen(false);}} icon={<Home size={18}/>}>Início</MobileNavItem>
                        <MobileNavItem onClick={() => { navigate('opportunities'); setIsMobileMenuOpen(false);}} icon={<Search size={18}/>}>Oportunidades</MobileNavItem>
                         {currentUser && userData && (
                            <>
                                {userData.role === 'volunteer' && <MobileNavItem onClick={() => {navigate('volunteerDashboard'); setIsMobileMenuOpen(false);}} icon={<UserCircle size={18}/>}>Meu Painel</MobileNavItem>}
                                {userData.role === 'organization' && <MobileNavItem onClick={() => {navigate('organizationDashboard'); setIsMobileMenuOpen(false);}} icon={<Building size={18}/>}>Painel da ONG</MobileNavItem>}
                                <MobileNavItem onClick={() => {navigate('profile'); setIsMobileMenuOpen(false);}} icon={<Settings size={18}/>}>Perfil</MobileNavItem>
                                <button
                                    onClick={() => {handleSignOut(); setIsMobileMenuOpen(false);}}
                                    className="w-full text-left flex items-center px-3 py-2 rounded-md text-base font-medium hover:bg-indigo-500 transition duration-150"
                                >
                                    <LogOut size={18} className="mr-1" /> Sair
                                </button>
                            </>
                        )}
                        {!currentUser && (
                            <>
                                <button
                                    onClick={() => { setAuthMode('login'); setShowAuthModal(true); setIsMobileMenuOpen(false);}}
                                    className="w-full text-left flex items-center px-3 py-2 rounded-md text-base font-medium hover:bg-indigo-500 transition duration-150"
                                >
                                    <LogIn size={18} className="mr-1" /> Entrar
                                </button>
                                <button
                                    onClick={() => { setAuthMode('signup'); setShowAuthModal(true); setIsMobileMenuOpen(false);}}
                                    className="w-full text-left flex items-center bg-yellow-400 text-blue-700 px-3 py-2 rounded-md text-base font-medium hover:bg-yellow-300 transition duration-150"
                                >
                                    <UserPlus size={18} className="mr-1" /> Cadastrar
                                </button>
                            </>
                        )}
                    </div>
                </div>
            )}
        </nav>
    );
};

const NavItem = ({ onClick, children, icon }) => (
    <button onClick={onClick} className="flex items-center px-3 py-2 rounded-md text-sm font-medium hover:bg-indigo-500 transition duration-150">
        {icon && React.cloneElement(icon, { className: "mr-1"})}
        {children}
    </button>
);

const MobileNavItem = ({ onClick, children, icon }) => (
     <button onClick={onClick} className="w-full text-left flex items-center px-3 py-2 rounded-md text-base font-medium hover:bg-indigo-500 transition duration-150">
        {icon && React.cloneElement(icon, { className: "mr-2"})}
        {children}
    </button>
);

// Footer Component
const Footer = () => (
    <footer className="bg-gray-800 text-white py-8 text-center">
        <p>&copy; {new Date().getFullYear()} VolunTech. Conectando corações, transformando comunidades.</p>
        <p className="text-sm text-gray-400 mt-1">Inspirado no projeto de Gestão de Projetos.</p>
    </footer>
);

// Auth Modal
const AuthModal = ({ mode, setMode, onClose, navigate, handleShowMessage }) => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [confirmPassword, setConfirmPassword] = useState('');
    const [name, setName] = useState('');
    const [role, setRole] = useState('volunteer'); 
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    const [showPassword, setShowPassword] = useState(false);
    const [showConfirmPassword, setShowConfirmPassword] = useState(false);
    const { setUserData: updateAuthContextUserData } = useAuth();


    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        if (mode === 'signup') {
            if (password !== confirmPassword) {
                setError('As senhas não coincidem.');
                setLoading(false);
                return;
            }
            if (password.length < 6) {
                setError('A senha deve ter pelo menos 6 caracteres.');
                setLoading(false);
                return;
            }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await updateProfile(user, { displayName: name });

                const userDocRef = doc(db, `/artifacts/${appId}/public/data/users/${user.uid}`);
                const newUserProfile = {
                    name: name,
                    email: user.email,
                    role: role,
                    createdAt: Timestamp.now(),
                    profileImageUrl: '',
                    bio: '',
                    skills: role === 'volunteer' ? [] : undefined,
                    interests: role === 'volunteer' ? [] : undefined,
                    organizationMission: role === 'organization' ? '' : undefined,
                    organizationWebsite: role === 'organization' ? '' : undefined,
                };
                await setDoc(userDocRef, newUserProfile);
                
                updateAuthContextUserData({ id: user.uid, ...newUserProfile }); 

                handleShowMessage('Cadastro realizado com sucesso! Bem-vindo(a)!', 'success');
                onClose();
                navigate(role === 'volunteer' ? 'volunteerDashboard' : 'organizationDashboard');
            } catch (err) {
                setError(err.message);
                handleShowMessage(`Erro no cadastro: ${err.message}`, 'error');
            }
        } else { 
            try {
                await signInWithEmailAndPassword(auth, email, password);
                handleShowMessage('Login realizado com sucesso!', 'success');
                onClose();
                 navigate('home'); 
            } catch (err) {
                setError(err.message);
                handleShowMessage(`Erro no login: ${err.message}`, 'error');
            }
        }
        setLoading(false);
    };
    
    const inputFieldClass = "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500";
    const passwordToggleClass = "absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5 text-gray-500 hover:text-gray-700 cursor-pointer";

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-md transform transition-all">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-semibold text-gray-800">{mode === 'signup' ? 'Criar Conta' : 'Entrar'}</h2>
                    <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                {error && <MessageBox message={error} type="error" onDismiss={() => setError('')} />}
                <form onSubmit={handleSubmit} className="space-y-4">
                    {mode === 'signup' && (
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                            <input type="text" value={name} onChange={(e) => setName(e.target.value)} required className={inputFieldClass} />
                        </div>
                    )}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} required className={inputFieldClass} />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                        <div className="relative">
                            <input type={showPassword ? "text" : "password"} value={password} onChange={(e) => setPassword(e.target.value)} required className={inputFieldClass} />
                            <span onClick={() => setShowPassword(!showPassword)} className={passwordToggleClass}>
                                {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                            </span>
                        </div>
                    </div>
                    {mode === 'signup' && (
                        <>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Confirmar Senha</label>
                                 <div className="relative">
                                    <input type={showConfirmPassword ? "text" : "password"} value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} required className={inputFieldClass} />
                                    <span onClick={() => setShowConfirmPassword(!showConfirmPassword)} className={passwordToggleClass}>
                                        {showConfirmPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                                    </span>
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Eu sou</label>
                                <select value={role} onChange={(e) => setRole(e.target.value)} className={inputFieldClass}>
                                    <option value="volunteer">Voluntário(a)</option>
                                    <option value="organization">Organização</option>
                                </select>
                            </div>
                        </>
                    )}
                    <button type="submit" disabled={loading} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition duration-150 disabled:opacity-50 flex items-center justify-center">
                        {loading ? <div className="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div> : (mode === 'signup' ? 'Cadastrar' : 'Entrar')}
                    </button>
                </form>
                <p className="text-sm text-center text-gray-600 mt-6">
                    {mode === 'signup' ? 'Já tem uma conta? ' : 'Não tem uma conta? '}
                    <button onClick={() => setMode(mode === 'signup' ? 'login' : 'signup')} className="text-blue-600 hover:underline font-medium">
                        {mode === 'signup' ? 'Entre aqui' : 'Cadastre-se'}
                    </button>
                </p>
            </div>
        </div>
    );
};


// Pages
const sampleEvents = [
    {
        id: 'webinar-voluntariado-digital',
        title: 'Webinar: O Impacto do Voluntariado Digital',
        date: '15 de Junho de 2025',
        time: '19:00 - 20:30',
        location: 'Online (Link será enviado aos inscritos)',
        description: 'Descubra como você pode contribuir para causas sociais e desenvolver novas habilidades sem sair de casa. Especialistas compartilharão insights e oportunidades no crescente campo do voluntariado digital. Ideal para quem busca flexibilidade e impacto.\n\nTemas abordados:\n- O que é voluntariado digital?\n- Plataformas e ferramentas úteis.\n- Como encontrar oportunidades remotas.\n- Histórias de sucesso e impacto.',
        organizer: 'VolunTech Hub',
        imageUrl: 'https://placehold.co/800x300/EF4444/FFFFFF?text=Webinar+Voluntariado', // Red
        registrationFields: ['Nome Completo', 'Email']
    },
    {
        id: 'mutirao-limpeza-praia',
        title: 'Mutirão de Limpeza da Praia Central',
        date: '22 de Junho de 2025',
        time: '09:00 - 12:00',
        location: 'Praia Central (Ponto de Encontro: Quiosque do Sol)',
        description: 'Junte-se a nós para um dia de conscientização e ação pelo meio ambiente! Vamos limpar a Praia Central, coletando resíduos e promovendo a importância da preservação costeira. Equipamentos (luvas e sacos) serão fornecidos. Traga sua garrafa de água reutilizável e protetor solar!\n\nProgramação:\n- 09:00: Boas-vindas e instruções.\n- 09:30: Início da coleta.\n- 11:30: Pesagem do material coletado e encerramento.',
        organizer: 'Amigos da Praia Limpa',
        imageUrl: 'https://placehold.co/800x300/22C55E/FFFFFF?text=Mutirão+Praia', // Green
        registrationFields: ['Nome Completo', 'Email', 'Telefone (Opcional)']
    }
];

const HomePage = ({ navigate, setShowAuthModal, setAuthMode }) => {
    const { currentUser } = useAuth();
    return (
    <div className="text-center">
        <header className="bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-20 rounded-lg shadow-xl mb-12">
            <h1 className="text-5xl font-bold mb-4">Bem-vindo ao VolunTech!</h1>
            <p className="text-xl mb-8 max-w-2xl mx-auto">Sua plataforma para encontrar e oferecer oportunidades de voluntariado. Juntos, podemos fazer a diferença.</p>
            <div className="space-y-4 sm:space-y-0 sm:space-x-4">
                <button 
                    onClick={() => navigate('opportunities')}
                    className="w-full sm:w-auto bg-yellow-400 hover:bg-yellow-500 text-blue-700 font-semibold py-3 px-8 rounded-lg text-lg shadow-md transition duration-150 transform hover:scale-105"
                >
                    <Search className="inline mr-2" /> Ver Oportunidades
                </button>
                {!currentUser && (
                    <button 
                        onClick={() => { setAuthMode('signup'); setShowAuthModal(true); }}
                        className="w-full sm:w-auto bg-white hover:bg-gray-100 text-indigo-600 font-semibold py-3 px-8 rounded-lg text-lg shadow-md transition duration-150 transform hover:scale-105"
                    >
                        <UserPlus className="inline mr-2" /> Cadastre-se / Cadastrar ONG
                    </button>
                )}
            </div>
        </header>

        <section className="py-12">
            <h2 className="text-3xl font-semibold text-gray-800 mb-10 flex items-center justify-center">
                <Sparkles size={32} className="mr-3 text-yellow-500" /> Como Funciona?
            </h2>
            <div className="grid md:grid-cols-3 gap-8">
                <div className="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-1">
                    <UserCircle size={48} className="text-blue-500 mx-auto mb-4" />
                    <h3 className="text-xl font-semibold text-gray-700 mb-2">Para Voluntários</h3>
                    <p className="text-gray-600">Crie seu perfil, explore vagas por causa ou habilidade e candidate-se com facilidade.</p>
                </div>
                <div className="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-1">
                    <Building size={48} className="text-green-500 mx-auto mb-4" />
                    <h3 className="text-xl font-semibold text-gray-700 mb-2">Para Organizações</h3>
                    <p className="text-gray-600">Cadastre sua ONG, publique suas necessidades e encontre voluntários engajados.</p>
                </div>
                <div className="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-1">
                    <HeartHandshake size={48} className="text-red-500 mx-auto mb-4" />
                    <h3 className="text-xl font-semibold text-gray-700 mb-2">Conectando Pessoas</h3>
                    <p className="text-gray-600">Facilitamos o encontro entre quem quer ajudar e quem precisa de ajuda.</p>
                </div>
            </div>
        </section>

        <section className="py-16 bg-gray-50 rounded-lg my-12">
            <h2 className="text-3xl font-semibold text-gray-800 mb-10 flex items-center justify-center">
                <Quote size={32} className="mr-3 text-indigo-500" /> O Que Dizem Nossos Usuários
            </h2>
            <div className="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto px-4">
                <div className="bg-white p-8 rounded-lg shadow-lg">
                    <Star size={24} className="text-yellow-400 mb-3" />
                    <p className="text-gray-600 italic mb-4">"Encontrei uma causa que realmente me toca e pude fazer a diferença. O VolunTech tornou tudo mais fácil e prático!"</p>
                    <p className="font-semibold text-gray-700">Ana Silva</p>
                    <p className="text-sm text-blue-500">Voluntária Dedicada</p>
                </div>
                <div className="bg-white p-8 rounded-lg shadow-lg">
                    <Star size={24} className="text-yellow-400 mb-3" />
                    <p className="text-gray-600 italic mb-4">"Conseguimos muitos voluntários qualificados para nossos projetos através da plataforma. A gestão das vagas é intuitiva. Recomendo!"</p>
                    <p className="font-semibold text-gray-700">Carlos Oliveira</p>
                    <p className="text-sm text-green-500">Coordenador da ONG Bem Maior</p>
                </div>
            </div>
        </section>

        <section className="py-12 my-12">
            <h2 className="text-3xl font-semibold text-gray-800 mb-10 flex items-center justify-center">
                <CalendarDays size={32} className="mr-3 text-red-500" /> Participe dos Nossos Próximos Eventos
            </h2>
            <div className="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto px-4">
                {sampleEvents.map(event => (
                    <div 
                        key={event.id} 
                        onClick={() => navigate('eventDetails', event)}
                        className="bg-white p-6 rounded-lg shadow-lg border-l-4 border-red-500 hover:shadow-xl transition-shadow duration-300 cursor-pointer transform hover:-translate-y-1"
                    >
                        <img src={event.imageUrl} alt={event.title} className="w-full h-40 object-cover rounded-md mb-4"/>
                        <h3 className="text-xl font-semibold text-gray-700 mb-2">{event.title}</h3>
                        <p className="text-sm text-gray-500 mb-1"><CalendarDays size={16} className="inline mr-1" /> {event.date}</p>
                        <p className="text-sm text-gray-500 mb-3"><MapPin size={16} className="inline mr-1" /> {event.location.split('(')[0].trim()}</p>
                        <p className="text-gray-600 text-sm line-clamp-3">{event.description.split('\n')[0]}</p>
                        <span className="mt-4 text-red-600 hover:text-red-800 font-medium inline-block">Ver Detalhes &rarr;</span>
                    </div>
                ))}
            </div>
        </section>

        <section className="py-12 bg-blue-600 text-white rounded-lg mt-12">
             <h2 className="text-3xl font-semibold mb-8 flex items-center justify-center">
                <Users2 size={32} className="mr-3 text-yellow-400" /> Junte-se à Nossa Comunidade!
            </h2>
            <p className="text-lg max-w-3xl mx-auto leading-relaxed mb-8 px-4">
                O VolunTech nasceu da visão de criar um impacto social positivo através da tecnologia. 
                Nossa missão é simplificar e democratizar o acesso ao voluntariado.
            </p>
             <button 
                onClick={() => { setAuthMode('signup'); setShowAuthModal(true); }}
                className="bg-yellow-400 hover:bg-yellow-500 text-blue-700 font-semibold py-3 px-8 rounded-lg text-lg shadow-md transition duration-150 transform hover:scale-105"
            >
                Cadastre-se Agora
            </button>
        </section>
    </div>
)};

// START OF MODIFIED SECTION: OpportunitiesPage with region filter
const OpportunitiesPage = ({ navigate, setShowAuthModal, setAuthMode, handleShowMessage }) => {
    const [opportunities, setOpportunities] = useState([]);
    const [loading, setLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState('');
    const [filterCategory, setFilterCategory] = useState('');
    const [filterLocationType, setFilterLocationType] = useState('');
    const [filterRegion, setFilterRegion] = useState(''); // New state for region filter
    const [error, setError] = useState('');

    const categories = ["Ajuda Humanitária", "Assistência Social", "Meio Ambiente", "Educação", "Saúde", "Animais", "Cultura", "Direitos Humanos", "Tecnologia Social", "Outros"];
    const regions = ["Norte", "Nordeste", "Sul", "Sudeste", "Centro-Oeste"]; // Brazilian regions

    const exampleOpportunities = [
        {
            id: 'example-rs-1',
            title: 'Apoio às Vítimas das Enchentes no RS',
            description: 'Precisamos de voluntários para triagem de doações, preparo de alimentos e apoio logístico nos abrigos para as famílias afetadas pelas enchentes no Rio Grande do Sul. Toda ajuda é bem-vinda!',
            organizationName: 'SOS Enchentes RS',
            organizationId: 'org-sos-rs',
            category: 'Ajuda Humanitária',
            region: 'Sul', // Added region
            date: Timestamp.fromDate(new Date('2025-06-10')),
            time: 'Integral (turnos a combinar)',
            locationType: 'Presencial',
            address: { street: 'Centro de Doações Estadual', city: 'Porto Alegre', state: 'RS', zip: '90000-000' },
            skillsRequired: ['Organização', 'Força física (para carregar doações)', 'Empatia'],
            numberOfVolunteersNeeded: 50,
            contactEmail: 'contato@sosenchentesrs.org',
            status: 'Aberta',
            createdAt: Timestamp.fromDate(new Date('2025-05-20T10:00:00Z')),
            imageUrl: `https://placehold.co/600x400/3B82F6/FFFFFF?text=Ajuda+RS` 
        },
        {
            id: 'example-brumadinho-2',
            title: 'Suporte Psicossocial Comunidade Impactada',
            description: 'Voluntários psicólogos e assistentes sociais para oferecer escuta e apoio emocional às famílias e indivíduos ainda impactados pela tragédia da barragem. Atendimento presencial e online.',
            organizationName: 'Cuidar Brumadinho',
            organizationId: 'org-cuidar-bruma',
            category: 'Assistência Social',
            region: 'Sudeste', // Added region
            date: Timestamp.fromDate(new Date('2025-07-01')),
            time: 'Flexível (online), Sábados (presencial)',
            locationType: 'Presencial', 
            address: { street: 'Centro Comunitário Esperança', city: 'Brumadinho', state: 'MG', zip: '35660-000' },
            skillsRequired: ['Psicologia', 'Assistência Social', 'Escuta ativa'],
            numberOfVolunteersNeeded: 15,
            contactEmail: 'apoio@cuidarbrumadinho.org',
            status: 'Aberta',
            createdAt: Timestamp.fromDate(new Date('2025-05-18T14:30:00Z')),
            imageUrl: `https://placehold.co/600x400/10B981/FFFFFF?text=Apoio+Psicossocial` 
        },
        {
            id: 'example-amazonia-3',
            title: 'Reflorestamento de Áreas Degradadas na Amazônia',
            description: 'Junte-se a nós em expedições para o plantio de mudas nativas em áreas de reflorestamento na Amazônia. Uma experiência única de contato com a natureza e contribuição para o futuro do planeta.',
            organizationName: 'Verde Amazônia ONG',
            organizationId: 'org-verde-amazonia',
            category: 'Meio Ambiente',
            region: 'Norte', // Added region
            date: Timestamp.fromDate(new Date('2025-08-15')), 
            time: 'Período de 7 dias (expedição)',
            locationType: 'Presencial',
            address: { street: 'Base da ONG (ponto de encontro)', city: 'Manaus', state: 'AM', zip: '69000-000' },
            skillsRequired: ['Disposição física', 'Amor pela natureza', 'Trabalho em equipe'],
            numberOfVolunteersNeeded: 20,
            contactEmail: 'voluntarios@verdeamazonia.org',
            status: 'Aberta',
            createdAt: Timestamp.fromDate(new Date('2025-05-15T09:00:00Z')),
            imageUrl: `https://placehold.co/600x400/22C55E/FFFFFF?text=Reflorestamento` 
        },
        {
            id: 'example-educacao-4',
            title: 'Professor de Reforço Online (Matemática)',
            description: 'Seja um tutor online e ajude crianças de comunidades carentes a melhorarem seu desempenho em Matemática. Aulas semanais via plataforma digital, material didático fornecido.',
            organizationName: 'EducaAção Digital',
            organizationId: 'org-educacao-digital',
            category: 'Educação',
            region: 'Todas', // Example for remote, can be any region or 'Todas'
            date: null, 
            time: '2-4 horas/semana (flexível)',
            locationType: 'Remoto',
            address: null,
            skillsRequired: ['Didática', 'Conhecimento em Matemática (fundamental)', 'Paciência'],
            numberOfVolunteersNeeded: 30,
            contactEmail: 'tutoria@educacaodigital.org',
            status: 'Aberta',
            createdAt: Timestamp.fromDate(new Date('2025-05-10T11:00:00Z')),
            imageUrl: `https://placehold.co/600x400/F97316/FFFFFF?text=Educação+Online` 
        },
        {
            id: 'example-saude-5',
            title: 'Apoio em Campanha de Doação de Sangue',
            description: 'Participe da nossa campanha de doação de sangue auxiliando na recepção dos doadores, organização do lanche e divulgação. Sua ajuda salva vidas!',
            organizationName: 'Hemocentro Vida+',
            organizationId: 'org-hemocentro-vidamais',
            category: 'Saúde',
            region: 'Sudeste', // Added region
            date: Timestamp.fromDate(new Date('2025-06-25')),
            time: '09:00 - 17:00 (turnos disponíveis)',
            locationType: 'Presencial',
            address: { street: 'Av. Principal, 123', city: 'São Paulo', state: 'SP', zip: '01000-000' },
            skillsRequired: ['Comunicação', 'Organização', 'Proatividade'],
            numberOfVolunteersNeeded: 25,
            contactEmail: 'campanha@hemovidamais.org.br',
            status: 'Aberta',
            createdAt: Timestamp.fromDate(new Date('2025-05-05T16:00:00Z')),
            imageUrl: `https://placehold.co/600x400/EF4444/FFFFFF?text=Doação+de+Sangue` 
        }
    ];

    useEffect(() => {
        setLoading(true);
        setError('');
        // For now, using example data. Firestore fetching logic is commented out.
        // If re-enabling Firestore, ensure opportunities have a 'region' field.
        const sortedExampleOpportunities = [...exampleOpportunities].sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());
        setOpportunities(sortedExampleOpportunities);
        setLoading(false);

        /*
        const fetchOpportunities = async () => {
            setLoading(true);
            setError('');
            try {
                const opportunitiesRef = collection(db, `/artifacts/${appId}/public/data/opportunities`);
                // Add orderBy("region") if you want to sort by region in Firestore,
                // but this requires a composite index if combined with other orderBy or where clauses.
                let q = query(opportunitiesRef, where("status", "==", "Aberta"), orderBy("createdAt", "desc"));
                
                const querySnapshot = await getDocs(q);
                const oppsList = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setOpportunities(oppsList);
            } catch (err) {
                console.error("Error fetching opportunities: ", err);
                setError("Não foi possível carregar as oportunidades. Tente novamente mais tarde.");
            }
            setLoading(false);
        };
        fetchOpportunities();
        */
    }, []);

    const filteredOpportunities = opportunities.filter(opp => {
        const titleMatch = opp.title.toLowerCase().includes(searchTerm.toLowerCase());
        const categoryMatch = filterCategory ? opp.category === filterCategory : true;
        const locationTypeMatch = filterLocationType ? opp.locationType === filterLocationType : true;
        const regionMatch = filterRegion ? (opp.region === filterRegion || opp.region === 'Todas') : true; // Updated for region
        return titleMatch && categoryMatch && locationTypeMatch && regionMatch;
    });

    if (loading) return <div className="flex justify-center items-center py-10"><div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div></div>;
    if (error) return <MessageBox message={error} type="error" />;

    return (
        <div>
            <h1 className="text-3xl font-bold text-gray-800 mb-8">Encontre Oportunidades</h1>
            <div className="mb-8 p-6 bg-white rounded-lg shadow-md">
                <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-4"> {/* Adjusted grid for new filter */}
                    <input 
                        type="text" 
                        placeholder="Buscar por título..." 
                        value={searchTerm} 
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    />
                    <select 
                        value={filterCategory} 
                        onChange={(e) => setFilterCategory(e.target.value)}
                        className="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    >
                        <option value="">Todas as Categorias</option>
                        {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                    </select>
                    <select 
                        value={filterLocationType} 
                        onChange={(e) => setFilterLocationType(e.target.value)}
                        className="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    >
                        <option value="">Todos os Tipos de Local</option>
                        <option value="Presencial">Presencial</option>
                        <option value="Remoto">Remoto</option>
                    </select>
                    <select 
                        value={filterRegion} 
                        onChange={(e) => setFilterRegion(e.target.value)}
                        className="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    >
                        <option value="">Todas as Regiões</option>
                        {regions.map(reg => <option key={reg} value={reg}>{reg}</option>)}
                        <option value="Todas">Todas (para remoto)</option>
                    </select>
                </div>
            </div>

            {filteredOpportunities.length === 0 ? (
                <p className="text-center text-gray-600 text-lg py-10">Nenhuma oportunidade encontrada com os filtros atuais.</p>
            ) : (
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {filteredOpportunities.map(opp => (
                        <OpportunityCard 
                            key={opp.id} 
                            opportunity={opp} 
                            navigate={navigate} 
                            setShowAuthModal={setShowAuthModal} 
                            setAuthMode={setAuthMode}
                            handleShowMessage={handleShowMessage}
                        />
                    ))}
                </div>
            )}
        </div>
    );
};
// END OF MODIFIED SECTION

const OpportunityCard = ({ opportunity, navigate, setShowAuthModal, setAuthMode, handleShowMessage }) => {
    const { currentUser, userData } = useAuth();

    const handleQuickApply = () => {
        if (!currentUser) {
            setAuthMode('login');
            setShowAuthModal(true);
            return;
        }
        if (userData?.role !== 'volunteer') {
            handleShowMessage("Apenas voluntários podem se candidatar a oportunidades.", "error");
            return;
        }
        navigate('opportunityApplication', opportunity);
    };

    return (
        <div className="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-shadow duration-300 flex flex-col">
            <img 
                src={opportunity.imageUrl || `https://placehold.co/600x400/E0E7FF/4F46E5?text=${encodeURIComponent(opportunity.title.substring(0,15))}`} 
                alt={`Imagem para ${opportunity.title}`} 
                className="w-full h-48 object-cover"
                onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/600x400/CCCCCC/FFFFFF?text=Imagem+Indisponível`; }}
            />
            <div className="p-6 flex flex-col flex-grow">
                <h2 className="text-xl font-semibold text-blue-700 mb-2">{opportunity.title}</h2>
                <div className="flex items-center text-sm text-gray-500 mb-2">
                    <Building size={16} className="mr-2 text-indigo-500" />
                    <span>{opportunity.organizationName}</span>
                </div>
                <div className="flex items-center text-sm text-gray-500 mb-1">
                    <MapPin size={16} className="mr-2 text-indigo-500" />
                    <span>{opportunity.locationType === 'Remoto' ? 'Remoto' : opportunity.address?.city || 'Local não especificado'}</span>
                </div>
                {opportunity.region && opportunity.region !== 'Todas' && (
                    <div className="flex items-center text-xs text-gray-400 mb-3">
                        <Globe size={14} className="mr-1 text-indigo-400" />
                        <span>Região: {opportunity.region}</span>
                    </div>
                )}
                <p className="text-gray-600 text-sm mb-4 line-clamp-3 flex-grow">{opportunity.description}</p>
                <div className="mt-auto space-y-2">
                    <button 
                        onClick={() => navigate('opportunityDetails', opportunity)}
                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-150 flex items-center justify-center"
                    >
                        <Info size={18} className="mr-2" /> Ver Detalhes
                    </button>
                    <button 
                        onClick={handleQuickApply}
                        className="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-md transition duration-150 flex items-center justify-center"
                    >
                        <FileText size={18} className="mr-2" /> Inscrever-se
                    </button>
                </div>
            </div>
        </div>
    );
};

const OpportunityDetailsPage = ({ opportunity, navigate }) => {
    const { currentUser, userData } = useAuth();
    const [message, setMessage] = useState('');
    const [applicationStatus, setApplicationStatus] = useState(null); 
    const [showApplyModal, setShowApplyModal] = useState(false);
    const [applicationMessage, setApplicationMessage] = useState('');

    useEffect(() => {
        const checkApplication = async () => {
            if (currentUser && opportunity && !opportunity.id.startsWith('example-')) { 
                try {
                    const q = query(
                        collection(db, `/artifacts/${appId}/public/data/applications`),
                        where("volunteerId", "==", currentUser.uid),
                        where("opportunityId", "==", opportunity.id)
                    );
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        setApplicationStatus('applied');
                    } else {
                        setApplicationStatus(null); // Not applied
                    }
                } catch (error) {
                    console.error("Error checking application status:", error);
                    setApplicationStatus('error');
                }
            } else if (opportunity && opportunity.id.startsWith('example-')) {
                const simulatedStatus = localStorage.getItem(`sim_app_${opportunity.id}_${currentUser?.uid}`);
                if (simulatedStatus === 'applied') {
                    setApplicationStatus('applied');
                } else {
                    setApplicationStatus(null);
                }
            }
        };
        checkApplication();
    }, [currentUser, opportunity]);


    const handleApply = async () => {
        if (!currentUser) {
            setMessage("Você precisa estar logado para se candidatar.");
            return;
        }
        if (userData?.role !== 'volunteer') {
            setMessage("Apenas voluntários podem se candidatar a oportunidades.");
            return;
        }
        if (opportunity.id.startsWith('example-')) {
            setApplicationStatus('loading');
            setTimeout(() => {
                setMessage("Candidatura para vaga de exemplo enviada (simulação)!");
                setApplicationStatus('applied');
                localStorage.setItem(`sim_app_${opportunity.id}_${currentUser.uid}`, 'applied'); 
                setShowApplyModal(false);
                setApplicationMessage('');
            }, 1000);
            return;
        }

        setApplicationStatus('loading');
        try {
            const applicationsRef = collection(db, `/artifacts/${appId}/public/data/applications`);
            await addDoc(applicationsRef, {
                opportunityId: opportunity.id,
                opportunityTitle: opportunity.title,
                organizationId: opportunity.organizationId,
                organizationName: opportunity.organizationName,
                volunteerId: currentUser.uid,
                volunteerName: userData.name, 
                volunteerEmail: currentUser.email, 
                applicationDate: Timestamp.now(),
                status: 'Pendente', 
                messageToOrg: applicationMessage,
                messageFromOrg: ''
            });
            setMessage("Candidatura enviada com sucesso!");
            setApplicationStatus('applied');
            setShowApplyModal(false);
            setApplicationMessage('');
        } catch (error) {
            console.error("Error applying for opportunity: ", error);
            setMessage("Erro ao enviar candidatura. Tente novamente.");
            setApplicationStatus('error');
        }
    };

    if (!opportunity) return <p>Oportunidade não encontrada.</p>;

    return (
        <div className="bg-white p-6 sm:p-8 rounded-lg shadow-xl max-w-4xl mx-auto">
            <button onClick={() => navigate('opportunities')} className="mb-6 text-blue-600 hover:text-blue-800 font-medium flex items-center">
                <ArrowLeft size={20} className="mr-1" /> Voltar para Oportunidades
            </button>
            
            {opportunity.imageUrl && (
                 <img 
                    src={opportunity.imageUrl} 
                    alt={`Imagem para ${opportunity.title}`} 
                    className="w-full h-64 object-cover rounded-lg mb-6 shadow-md"
                    onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/800x400/CCCCCC/FFFFFF?text=Imagem+Indisponível`; }}
                />
            )}

            <h1 className="text-3xl sm:text-4xl font-bold text-blue-700 mb-4">{opportunity.title}</h1>
            <div className="flex items-center text-gray-600 mb-2">
                <Building size={20} className="mr-2 text-indigo-600" />
                <span className="text-lg">{opportunity.organizationName}</span>
            </div>
             {opportunity.region && opportunity.region !== 'Todas' && (
                <div className="flex items-center text-sm text-gray-500 mb-4">
                    <Globe size={16} className="mr-2 text-indigo-500" />
                    <span>Região: {opportunity.region}</span>
                </div>
            )}
            
            <div className="grid md:grid-cols-2 gap-6 mb-6 text-sm">
                <InfoPill icon={<MapPin size={18} />} label="Local" value={`${opportunity.locationType}${opportunity.locationType === 'Presencial' && opportunity.address ? `: ${opportunity.address.street || ''}, ${opportunity.address.city || ''} - ${opportunity.address.state || ''}` : ''}`} />
                <InfoPill icon={<CalendarDays size={18} />} label="Data" value={opportunity.date ? new Date(opportunity.date.seconds * 1000).toLocaleDateString('pt-BR') : 'A definir'} />
                <InfoPill icon={<Clock size={18} />} label="Horário" value={opportunity.time || 'A definir'} />
                <InfoPill icon={<Award size={18} />} label="Categoria" value={opportunity.category || 'Não especificada'} />
                <InfoPill icon={<Users size={18} />} label="Vagas" value={opportunity.numberOfVolunteersNeeded || 'N/A'} />
                <InfoPill icon={<Mail size={18} />} label="Contato" value={opportunity.contactEmail || 'Não informado'} />
            </div>

            <div className="mb-6">
                <h2 className="text-xl font-semibold text-gray-800 mb-2">Descrição da Oportunidade</h2>
                <p className="text-gray-700 leading-relaxed whitespace-pre-wrap">{opportunity.description}</p>
            </div>

            {opportunity.skillsRequired && opportunity.skillsRequired.length > 0 && (
                <div className="mb-6">
                    <h2 className="text-xl font-semibold text-gray-800 mb-2">Habilidades Necessárias</h2>
                    <div className="flex flex-wrap gap-2">
                        {opportunity.skillsRequired.map(skill => (
                            <span key={skill} className="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-medium">{skill}</span>
                        ))}
                    </div>
                </div>
            )}
            
            {message && <MessageBox message={message} type={applicationStatus === 'applied' || message.includes('sucesso') || message.includes('simulação') ? 'success' : 'error'} onDismiss={() => setMessage('')} />}

            {currentUser && userData?.role === 'volunteer' && applicationStatus !== 'applied' && (
                <button 
                    onClick={() => setShowApplyModal(true)}
                    disabled={applicationStatus === 'loading'}
                    className="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg text-lg shadow-md transition duration-150 flex items-center justify-center disabled:opacity-50"
                >
                    {applicationStatus === 'loading' ? <div className="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white mr-2"></div> : <Send size={20} className="mr-2" />}
                    Quero Participar!
                </button>
            )}
            {currentUser && userData?.role === 'volunteer' && applicationStatus === 'applied' && (
                <p className="text-green-600 font-semibold text-lg flex items-center">
                    <CheckCircle size={24} className="mr-2" /> Você já se candidatou para esta oportunidade {opportunity.id.startsWith('example-') ? '(simulação)' : ''}.
                </p>
            )}
            {!currentUser && (
                 <p className="text-yellow-600 font-semibold text-lg p-4 bg-yellow-50 border border-yellow-300 rounded-md">
                    <Info size={20} className="inline mr-2" /> Faça login ou cadastre-se como voluntário para se candidatar.
                </p>
            )}
             {currentUser && userData?.role === 'organization' && (
                 <p className="text-blue-600 font-semibold text-lg p-4 bg-blue-50 border border-blue-300 rounded-md">
                    <Info size={20} className="inline mr-2" /> Esta é a visualização {opportunity.id.startsWith('example-') ? 'de uma vaga de exemplo' : 'da sua oportunidade'}. Voluntários podem se candidatar aqui.
                </p>
            )}

            {showApplyModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
                        <h3 className="text-xl font-semibold mb-4">Confirmar Candidatura</h3>
                        <p className="mb-1">Você está se candidatando para: <strong>{opportunity.title}</strong></p>
                        <p className="text-sm text-gray-600 mb-4">Organização: {opportunity.organizationName}</p>
                        
                        <div className="mb-4">
                            <label htmlFor="applicationMessage" className="block text-sm font-medium text-gray-700 mb-1">
                                Mensagem para a organização (opcional):
                            </label>
                            <textarea
                                id="applicationMessage"
                                rows="3"
                                value={applicationMessage}
                                onChange={(e) => setApplicationMessage(e.target.value)}
                                className="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:outline-none"
                                placeholder="Deixe uma breve mensagem, se desejar..."
                            ></textarea>
                        </div>

                        <div className="flex justify-end space-x-3">
                            <button onClick={() => setShowApplyModal(false)} className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancelar</button>
                            <button onClick={handleApply} disabled={applicationStatus === 'loading'} className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md disabled:opacity-50">
                                {applicationStatus === 'loading' ? 'Enviando...' : 'Confirmar e Enviar'}
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

const InfoPill = ({ icon, label, value }) => (
    <div className="bg-gray-50 p-3 rounded-lg flex items-start shadow-sm">
        {React.cloneElement(icon, { className: "text-blue-600 mr-3 mt-1 flex-shrink-0"})}
        <div>
            <p className="text-xs text-gray-500 font-medium">{label}</p>
            <p className="text-gray-800 font-semibold">{value}</p>
        </div>
    </div>
);

const VolunteerDashboard = ({ navigate }) => {
    const { userData } = useAuth();
    const [myApplications, setMyApplications] = useState([]);
    const [loadingApps, setLoadingApps] = useState(true);
    const [errorApps, setErrorApps] = useState('');

    useEffect(() => {
        if (userData && userData.id) {
            setLoadingApps(true);
            setErrorApps('');
            const appsRef = collection(db, `/artifacts/${appId}/public/data/applications`);
            const q = query(appsRef, where("volunteerId", "==", userData.id), orderBy("applicationDate", "desc"));
            
            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                const appsList = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setMyApplications(appsList);
                setLoadingApps(false);
            }, (error) => {
                console.error("Error fetching applications: ", error);
                setErrorApps("Não foi possível carregar suas candidaturas.");
                setLoadingApps(false);
            });
            return () => unsubscribe();
        }
    }, [userData]);

    return (
        <div>
            <h1 className="text-3xl font-bold text-gray-800 mb-2">Painel do Voluntário</h1>
            <p className="text-lg text-gray-600 mb-8">Bem-vindo(a) de volta, {userData?.name}!</p>

            <div className="bg-white p-6 rounded-lg shadow-md">
                <h2 className="text-2xl font-semibold text-gray-700 mb-6 flex items-center"><ListChecks size={28} className="mr-3 text-blue-600"/>Minhas Candidaturas</h2>
                {loadingApps && <p>Carregando candidaturas...</p>}
                {errorApps && <MessageBox message={errorApps} type="error" />}
                {!loadingApps && myApplications.length === 0 && (
                    <p className="text-gray-600">Você ainda não se candidatou a nenhuma oportunidade real. <button onClick={() => navigate('opportunities')} className="text-blue-600 hover:underline">Explore vagas agora!</button></p>
                )}
                {!loadingApps && myApplications.length > 0 && (
                    <div className="space-y-4">
                        {myApplications.map(app => (
                            <div key={app.id} className="border border-gray-200 p-4 rounded-lg hover:shadow-sm transition-shadow">
                                <h3 className="text-lg font-semibold text-blue-700">{app.opportunityTitle}</h3>
                                <p className="text-sm text-gray-500">Organização: {app.organizationName}</p>
                                <p className="text-sm text-gray-500">Data da candidatura: {new Date(app.applicationDate.seconds * 1000).toLocaleDateString('pt-BR')}</p>
                                <p className="text-sm font-medium mt-1">Status: <StatusBadge status={app.status} /></p>
                                {app.messageToOrg && <p className="text-xs text-gray-500 mt-1 italic">Sua mensagem: "{app.messageToOrg}"</p>}
                                {app.messageFromOrg && <p className="text-xs text-green-600 mt-1 italic">Resposta da ONG: "{app.messageFromOrg}"</p>}
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
};

const StatusBadge = ({ status }) => {
    let colorClasses = '';
    let IconComponent = Info;

    switch (status) {
        case 'Pendente':
            colorClasses = 'bg-yellow-100 text-yellow-700';
            IconComponent = Clock;
            break;
        case 'Aprovado':
            colorClasses = 'bg-green-100 text-green-700';
            IconComponent = CheckCircle;
            break;
        case 'Rejeitado':
            colorClasses = 'bg-red-100 text-red-700';
            IconComponent = XCircle;
            break;
        default:
            colorClasses = 'bg-gray-100 text-gray-700';
    }
    return (
        <span className={`px-2 py-1 rounded-full text-xs font-semibold inline-flex items-center ${colorClasses}`}>
            <IconComponent size={14} className="mr-1" /> {status}
        </span>
    );
};


const OrganizationDashboard = ({ navigate }) => {
    const { userData } = useAuth();
    const [myOpportunities, setMyOpportunities] = useState([]);
    const [loadingOpps, setLoadingOpps] = useState(true);
    const [errorOpps, setErrorOpps] = useState('');
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [editingOpportunity, setEditingOpportunity] = useState(null); 
    const [showApplicantsModal, setShowApplicantsModal] = useState(false);
    const [selectedOppForApplicants, setSelectedOppForApplicants] = useState(null);


    const fetchOpportunities = async () => {
        if (userData && userData.id) {
            setLoadingOpps(true);
            setErrorOpps('');
            try {
                const oppsRef = collection(db, `/artifacts/${appId}/public/data/opportunities`);
                const q = query(oppsRef, where("organizationId", "==", userData.id), orderBy("createdAt", "desc"));
                
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const oppsList = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setMyOpportunities(oppsList);
                    setLoadingOpps(false);
                }, (error) => {
                    console.error("Error fetching opportunities: ", error);
                    setErrorOpps("Não foi possível carregar suas oportunidades.");
                    setLoadingOpps(false);
                });
                return unsubscribe; 
            } catch (err) { 
                 console.error("Error setting up opportunity listener: ", err);
                 setErrorOpps("Erro ao configurar busca de oportunidades.");
                 setLoadingOpps(false);
            }
        }
    };
    
    useEffect(() => {
        const unsubscribe = fetchOpportunities();
        return () => {
            if (typeof unsubscribe === 'function') {
                unsubscribe();
            }
        };
    }, [userData]);


    const handleCreateOrUpdateOpportunity = async (opportunityData) => {
        try {
            if (editingOpportunity) { 
                const oppRef = doc(db, `/artifacts/${appId}/public/data/opportunities/${editingOpportunity.id}`);
                await updateDoc(oppRef, opportunityData);
            } else { 
                const oppsRef = collection(db, `/artifacts/${appId}/public/data/opportunities`);
                await addDoc(oppsRef, {
                    ...opportunityData,
                    organizationId: userData.id,
                    organizationName: userData.name,
                    createdAt: Timestamp.now(),
                    status: 'Aberta' 
                });
            }
            setShowCreateModal(false);
            setEditingOpportunity(null);
        } catch (error) {
            console.error("Error saving opportunity: ", error);
        }
    };
    
    const handleEditOpportunity = (opportunity) => {
        setEditingOpportunity(opportunity);
        setShowCreateModal(true);
    };

    const handleDeleteOpportunity = async (opportunityId) => {
        if (opportunityId.startsWith('example-')) {
            console.warn("Attempted to delete an example opportunity from dashboard.");
            return;
        }

        if (window.confirm("Tem certeza que deseja excluir esta oportunidade? Esta ação não pode ser desfeita.")) {
            try {
                const appsQuery = query(collection(db, `/artifacts/${appId}/public/data/applications`), where("opportunityId", "==", opportunityId));
                const appsSnapshot = await getDocs(appsQuery);
                const deletePromises = appsSnapshot.docs.map(appDoc => deleteDoc(doc(db, `/artifacts/${appId}/public/data/applications`, appDoc.id)));
                await Promise.all(deletePromises);
                await deleteDoc(doc(db, `/artifacts/${appId}/public/data/opportunities/${opportunityId}`));
            } catch (error) {
                console.error("Error deleting opportunity: ", error);
            }
        }
    };
    
    const handleViewApplicants = (opportunity) => {
        if (opportunity.id.startsWith('example-')) {
            alert("A visualização de candidatos para vagas de exemplo não está conectada ao banco de dados real.");
        }
        setSelectedOppForApplicants(opportunity);
        setShowApplicantsModal(true);
    };

    return (
        <div>
            <h1 className="text-3xl font-bold text-gray-800 mb-2">Painel da Organização</h1>
            <p className="text-lg text-gray-600 mb-8">Bem-vindo(a), {userData?.name}!</p>

            <div className="mb-8">
                <button 
                    onClick={() => { setEditingOpportunity(null); setShowCreateModal(true); }}
                    className="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg text-lg shadow-md transition duration-150 flex items-center"
                >
                    <PlusCircle size={22} className="mr-2" /> Criar Nova Oportunidade
                </button>
            </div>

            <div className="bg-white p-6 rounded-lg shadow-md">
                <h2 className="text-2xl font-semibold text-gray-700 mb-6 flex items-center"><Briefcase size={28} className="mr-3 text-blue-600"/>Minhas Oportunidades Publicadas</h2>
                {loadingOpps && <p>Carregando oportunidades...</p>}
                {errorOpps && <MessageBox message={errorOpps} type="error" />}
                {!loadingOpps && myOpportunities.length === 0 && (
                    <p className="text-gray-600">Você ainda não publicou nenhuma oportunidade.</p>
                )}
                {!loadingOpps && myOpportunities.length > 0 && (
                    <div className="space-y-6">
                        {myOpportunities.map(opp => (
                            <div key={opp.id} className="border border-gray-200 p-4 rounded-lg hover:shadow-md transition-shadow">
                                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2">
                                    <h3 className="text-xl font-semibold text-blue-700">{opp.title}</h3>
                                    <StatusBadge status={opp.status || "Aberta"} />
                                </div>
                                <p className="text-sm text-gray-500 mb-1">Categoria: {opp.category || 'N/A'}</p>
                                <p className="text-sm text-gray-500 mb-3">Publicada em: {new Date(opp.createdAt.seconds * 1000).toLocaleDateString('pt-BR')}</p>
                                <div className="flex flex-wrap gap-2 mt-3">
                                    <button onClick={() => handleViewApplicants(opp)} className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-md text-sm flex items-center"><Users size={16} className="mr-1"/>Ver Candidatos</button>
                                    <button onClick={() => handleEditOpportunity(opp)} className="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1.5 rounded-md text-sm flex items-center"><Edit3 size={16} className="mr-1"/>Editar</button>
                                    <button onClick={() => handleDeleteOpportunity(opp.id)} className="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-md text-sm flex items-center"><Trash2 size={16} className="mr-1"/>Excluir</button>
                                    <button onClick={() => navigate('opportunityDetails', opp)} className="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1.5 rounded-md text-sm flex items-center"><Eye size={16} className="mr-1"/>Visualizar</button>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
            {showCreateModal && <CreateOpportunityForm onClose={() => {setShowCreateModal(false); setEditingOpportunity(null);}} onSubmit={handleCreateOrUpdateOpportunity} existingOpportunity={editingOpportunity} />}
            {showApplicantsModal && selectedOppForApplicants && <ViewApplicantsModal opportunity={selectedOppForApplicants} onClose={() => setShowApplicantsModal(false)} />}
        </div>
    );
};

// START OF MODIFIED SECTION: CreateOpportunityForm with region field
const CreateOpportunityForm = ({ onClose, onSubmit, existingOpportunity }) => {
    const [title, setTitle] = useState(existingOpportunity?.title || '');
    const [description, setDescription] = useState(existingOpportunity?.description || '');
    const [category, setCategory] = useState(existingOpportunity?.category || '');
    const [region, setRegion] = useState(existingOpportunity?.region || ''); // New state for region
    const [date, setDate] = useState(existingOpportunity?.date?.seconds ? new Date(existingOpportunity.date.seconds * 1000).toISOString().split('T')[0] : '');
    const [time, setTime] = useState(existingOpportunity?.time || '');
    const [locationType, setLocationType] = useState(existingOpportunity?.locationType || 'Remoto');
    const [address, setAddress] = useState(existingOpportunity?.address || { street: '', city: '', state: '', zip: '' });
    const [skillsRequired, setSkillsRequired] = useState(existingOpportunity?.skillsRequired?.join(', ') || '');
    const [numberOfVolunteersNeeded, setNumberOfVolunteersNeeded] = useState(existingOpportunity?.numberOfVolunteersNeeded || 1);
    const [contactEmail, setContactEmail] = useState(existingOpportunity?.contactEmail || '');
    const [status, setStatus] = useState(existingOpportunity?.status || 'Aberta'); 
    const [loading, setLoading] = useState(false);

    const categories = ["Ajuda Humanitária", "Assistência Social", "Meio Ambiente", "Educação", "Saúde", "Animais", "Cultura", "Direitos Humanos", "Tecnologia Social", "Outros"];
    const regions = ["Norte", "Nordeste", "Sul", "Sudeste", "Centro-Oeste", "Todas"]; // Added "Todas" for remote opportunities

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        const opportunityData = {
            title,
            description,
            category,
            region, // Include region in data
            date: date ? Timestamp.fromDate(new Date(date)) : null,
            time,
            locationType,
            address: locationType === 'Presencial' ? address : null,
            skillsRequired: skillsRequired.split(',').map(s => s.trim()).filter(s => s),
            numberOfVolunteersNeeded: parseInt(numberOfVolunteersNeeded, 10),
            contactEmail,
            status 
        };
        if (!existingOpportunity) {
            delete opportunityData.status; 
        }
        await onSubmit(opportunityData);
        setLoading(false);
    };
    
    const inputClass = "w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:outline-none";
    const labelClass = "block text-sm font-medium text-gray-700 mb-1";

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
            <div className="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-2xl my-8">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-semibold text-gray-800">{existingOpportunity ? 'Editar Oportunidade' : 'Criar Nova Oportunidade'}</h2>
                    <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div><label className={labelClass}>Título da Oportunidade</label><input type="text" value={title} onChange={e => setTitle(e.target.value)} required className={inputClass} /></div>
                    <div><label className={labelClass}>Descrição Detalhada</label><textarea rows="4" value={description} onChange={e => setDescription(e.target.value)} required className={inputClass}></textarea></div>
                    <div className="grid md:grid-cols-2 gap-4">
                        <div><label className={labelClass}>Categoria</label>
                            <select value={category} onChange={e => setCategory(e.target.value)} required className={inputClass}>
                                <option value="">Selecione uma categoria</option>
                                {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                            </select>
                        </div>
                        <div><label className={labelClass}>Região de Atuação</label>
                            <select value={region} onChange={e => setRegion(e.target.value)} required className={inputClass}>
                                <option value="">Selecione uma região</option>
                                {regions.map(reg => <option key={reg} value={reg}>{reg}</option>)}
                            </select>
                        </div>
                    </div>
                    <div className="grid md:grid-cols-2 gap-4">
                        <div><label className={labelClass}>Data (Opcional)</label><input type="date" value={date} onChange={e => setDate(e.target.value)} className={inputClass} /></div>
                        <div><label className={labelClass}>Horário (Opcional)</label><input type="text" placeholder="Ex: 14:00 - 18:00" value={time} onChange={e => setTime(e.target.value)} className={inputClass} /></div>
                    </div>
                    <div><label className={labelClass}>Tipo de Local</label>
                        <select value={locationType} onChange={e => setLocationType(e.target.value)} className={inputClass}>
                            <option value="Remoto">Remoto</option>
                            <option value="Presencial">Presencial</option>
                        </select>
                    </div>
                    {locationType === 'Presencial' && (
                        <div className="p-3 border border-gray-200 rounded-md space-y-3 bg-gray-50">
                            <h4 className="text-sm font-medium text-gray-600">Endereço (Presencial)</h4>
                            <div><label className={labelClass}>Rua e Número</label><input type="text" value={address.street} onChange={e => setAddress({...address, street: e.target.value})} className={inputClass} /></div>
                            <div className="grid md:grid-cols-2 gap-4">
                                <div><label className={labelClass}>Cidade</label><input type="text" value={address.city} onChange={e => setAddress({...address, city: e.target.value})} className={inputClass} /></div>
                                <div><label className={labelClass}>Estado</label><input type="text" value={address.state} onChange={e => setAddress({...address, state: e.target.value})} className={inputClass} /></div>
                            </div>
                        </div>
                    )}
                    <div><label className={labelClass}>Habilidades Necessárias (separadas por vírgula)</label><input type="text" value={skillsRequired} onChange={e => setSkillsRequired(e.target.value)} className={inputClass} placeholder="Ex: Comunicação, Programação, Cozinha"/></div>
                    <div className="grid md:grid-cols-2 gap-4">
                        <div><label className={labelClass}>Nº de Voluntários Necessários</label><input type="number" min="1" value={numberOfVolunteersNeeded} onChange={e => setNumberOfVolunteersNeeded(e.target.value)} required className={inputClass} /></div>
                        <div><label className={labelClass}>Email de Contato</label><input type="email" value={contactEmail} onChange={e => setContactEmail(e.target.value)} required className={inputClass} /></div>
                    </div>
                     {existingOpportunity && (
                        <div>
                            <label className={labelClass}>Status da Oportunidade</label>
                            <select value={status} onChange={e => setStatus(e.target.value)} className={inputClass}>
                                <option value="Aberta">Aberta</option>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Fechada">Fechada</option>
                            </select>
                        </div>
                    )}
                    <div className="flex justify-end space-x-3 pt-4">
                        <button type="button" onClick={onClose} className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancelar</button>
                        <button type="submit" disabled={loading} className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md disabled:opacity-50">
                            {loading ? 'Salvando...' : (existingOpportunity ? 'Atualizar Oportunidade' : 'Criar Oportunidade')}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};
// END OF MODIFIED SECTION

const ViewApplicantsModal = ({ opportunity, onClose }) => {
    const [applicants, setApplicants] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState('');
    const [replyMessages, setReplyMessages] = useState({}); 

    useEffect(() => {
        if (opportunity.id.startsWith('example-')) {
            setApplicants([]); 
            setLoading(false);
            return;
        }

        setLoading(true);
        setError('');
        const appsRef = collection(db, `/artifacts/${appId}/public/data/applications`);
        const q = query(appsRef, where("opportunityId", "==", opportunity.id), orderBy("applicationDate", "desc"));
        
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
            const appsList = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setApplicants(appsList);
            setLoading(false);
        }, (err) => {
            console.error("Error fetching applicants: ", err);
            setError("Não foi possível carregar os candidatos.");
            setLoading(false);
        });
        return () => unsubscribe();
    }, [opportunity.id]);

    const handleUpdateStatus = async (applicationId, newStatus, message = '') => {
        if (opportunity.id.startsWith('example-') || applicationId.startsWith('example-')) {
            console.log(`Simulating update for example application ${applicationId} to status ${newStatus} with message: "${message}"`);
            alert(`Status do candidato exemplo atualizado para ${newStatus} (simulação).`);
            return;
        }
        try {
            const appRef = doc(db, `/artifacts/${appId}/public/data/applications/${applicationId}`);
            await updateDoc(appRef, { status: newStatus, messageFromOrg: message });
            if (message) setReplyMessages(prev => ({ ...prev, [applicationId]: '' })); 
        } catch (err) {
            console.error("Error updating application status: ", err);
        }
    };
    
    const handleReplyMessageChange = (applicationId, text) => {
        setReplyMessages(prev => ({ ...prev, [applicationId]: text }));
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-semibold text-gray-800">Candidatos para: {opportunity.title}</h2>
                    <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div className="overflow-y-auto flex-grow">
                    {loading && <p>Carregando candidatos...</p>}
                    {error && <MessageBox message={error} type="error" />}
                    {!loading && applicants.length === 0 && <p className="text-gray-600">Nenhum candidato para esta oportunidade ainda.</p>}
                    {!loading && applicants.length > 0 && (
                        <div className="space-y-4">
                            {applicants.map(app => (
                                <div key={app.id} className="border border-gray-200 p-4 rounded-lg">
                                    <h4 className="text-lg font-medium text-gray-800">{app.volunteerName}</h4>
                                    <p className="text-sm text-gray-500">Email: {app.volunteerEmail || 'Não informado'}</p>
                                    <p className="text-sm text-gray-500">Candidatou-se em: {new Date(app.applicationDate.seconds * 1000).toLocaleDateString('pt-BR')}</p>
                                    {app.messageToOrg && <p className="text-sm text-gray-600 mt-1 italic">Mensagem do voluntário: "{app.messageToOrg}"</p>}
                                    <div className="mt-3">
                                        <span className="text-sm font-medium mr-2">Status Atual:</span> <StatusBadge status={app.status} />
                                    </div>
                                    <div className="mt-3 space-y-2 sm:space-y-0 sm:flex sm:items-end sm:space-x-2">
                                        <div className="flex-grow">
                                            <label className="text-xs text-gray-600">Responder ao voluntário (opcional):</label>
                                            <input 
                                                type="text" 
                                                placeholder="Mensagem..."
                                                value={replyMessages[app.id] || app.messageFromOrg || ''}
                                                onChange={(e) => handleReplyMessageChange(app.id, e.target.value)}
                                                className="w-full p-1.5 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:outline-none"
                                            />
                                        </div>
                                        <div className="flex space-x-2 flex-shrink-0">
                                            <button onClick={() => handleUpdateStatus(app.id, 'Aprovado', replyMessages[app.id] || app.messageFromOrg)} className="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-md text-xs flex items-center"><CheckCircle size={14} className="mr-1"/>Aprovar</button>
                                            <button onClick={() => handleUpdateStatus(app.id, 'Rejeitado', replyMessages[app.id] || app.messageFromOrg)} className="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-md text-xs flex items-center"><XCircle size={14} className="mr-1"/>Rejeitar</button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
                 <button onClick={onClose} className="mt-6 w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 self-center">Fechar</button>
            </div>
        </div>
    );
};


const UserProfilePage = ({ navigate }) => {
    const { currentUser, userData, setUserData: updateAuthContextUserData } = useAuth();
    const [isEditing, setIsEditing] = useState(false);
    const [name, setName] = useState(userData?.name || '');
    const [bio, setBio] = useState(userData?.bio || '');
    const [skills, setSkills] = useState(userData?.skills?.join(', ') || '');
    const [interests, setInterests] = useState(userData?.interests?.join(', ') || '');
    const [organizationMission, setOrganizationMission] = useState(userData?.organizationMission || '');
    const [organizationWebsite, setOrganizationWebsite] = useState(userData?.organizationWebsite || '');
    
    const [loading, setLoading] = useState(false);
    const [message, setMessage] = useState({ text: '', type: '' });

    useEffect(() => { 
        if (userData) {
            setName(userData.name || '');
            setBio(userData.bio || '');
            if (userData.role === 'volunteer') {
                setSkills(userData.skills?.join(', ') || '');
                setInterests(userData.interests?.join(', ') || '');
            } else if (userData.role === 'organization') {
                setOrganizationMission(userData.organizationMission || '');
                setOrganizationWebsite(userData.organizationWebsite || '');
            }
        }
    }, [userData]);

    const handleSaveProfile = async () => {
        if (!currentUser) return;
        setLoading(true);
        setMessage({text: '', type: ''});

        const updatedProfileData = {
            name,
            bio,
        };

        if (userData.role === 'volunteer') {
            updatedProfileData.skills = skills.split(',').map(s => s.trim()).filter(s => s);
            updatedProfileData.interests = interests.split(',').map(i => i.trim()).filter(i => i);
        } else if (userData.role === 'organization') {
            updatedProfileData.organizationMission = organizationMission;
            updatedProfileData.organizationWebsite = organizationWebsite;
        }

        try {
            if (name !== currentUser.displayName) {
                await updateProfile(currentUser, { displayName: name });
            }

            const userDocRef = doc(db, `/artifacts/${appId}/public/data/users/${currentUser.uid}`);
            await updateDoc(userDocRef, updatedProfileData);
            
            const updatedUserDataInContext = { ...userData, ...updatedProfileData };
            updateAuthContextUserData(updatedUserDataInContext);

            setMessage({text: 'Perfil atualizado com sucesso!', type: 'success'});
            setIsEditing(false);
        } catch (error) {
            console.error("Error updating profile:", error);
            setMessage({text: `Erro ao atualizar perfil: ${error.message}`, type: 'error'});
        }
        setLoading(false);
    };
    
    const inputClass = "w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:outline-none bg-white disabled:bg-gray-100";
    const labelClass = "block text-sm font-medium text-gray-700 mb-1";
    const fieldWrapperClass = "mb-4";

    if (!userData) return <p>Carregando perfil...</p>;

    return (
        <div className="max-w-2xl mx-auto bg-white p-6 sm:p-8 rounded-lg shadow-xl">
            <div className="flex justify-between items-center mb-6">
                <h1 className="text-3xl font-bold text-gray-800">Meu Perfil</h1>
                {!isEditing && (
                    <button onClick={() => setIsEditing(true)} className="text-blue-600 hover:text-blue-800 font-medium flex items-center">
                        <Edit3 size={18} className="mr-1"/> Editar Perfil
                    </button>
                )}
            </div>

            {message.text && <MessageBox message={message.text} type={message.type} onDismiss={() => setMessage({text:'', type:''})} />}

            <div className={fieldWrapperClass}>
                <label className={labelClass}>Nome</label>
                <input type="text" value={name} onChange={e => setName(e.target.value)} disabled={!isEditing} className={inputClass} />
            </div>
            <div className={fieldWrapperClass}>
                <label className={labelClass}>Email</label>
                <input type="email" value={userData.email} disabled className={`${inputClass} bg-gray-100`} />
            </div>
            <div className={fieldWrapperClass}>
                <label className={labelClass}>Tipo de Conta</label>
                <input type="text" value={userData.role === 'volunteer' ? 'Voluntário(a)' : 'Organização'} disabled className={`${inputClass} bg-gray-100 capitalize`} />
            </div>
            <div className={fieldWrapperClass}>
                <label className={labelClass}>Sobre {userData.role === 'volunteer' ? 'Mim' : 'Nós'} (Bio)</label>
                <textarea rows="3" value={bio} onChange={e => setBio(e.target.value)} disabled={!isEditing} className={inputClass} placeholder={userData.role === 'volunteer' ? "Conte um pouco sobre você..." : "Descreva sua organização..."}></textarea>
            </div>

            {userData.role === 'volunteer' && (
                <>
                    <div className={fieldWrapperClass}>
                        <label className={labelClass}>Minhas Habilidades (separadas por vírgula)</label>
                        <input type="text" value={skills} onChange={e => setSkills(e.target.value)} disabled={!isEditing} className={inputClass} placeholder="Ex: Comunicação, Liderança, Pintura"/>
                    </div>
                    <div className={fieldWrapperClass}>
                        <label className={labelClass}>Meus Interesses/Causas (separadas por vírgula)</label>
                        <input type="text" value={interests} onChange={e => setInterests(e.target.value)} disabled={!isEditing} className={inputClass} placeholder="Ex: Educação, Meio Ambiente, Animais"/>
                    </div>
                </>
            )}

            {userData.role === 'organization' && (
                <>
                    <div className={fieldWrapperClass}>
                        <label className={labelClass}>Missão da Organização</label>
                        <textarea rows="3" value={organizationMission} onChange={e => setOrganizationMission(e.target.value)} disabled={!isEditing} className={inputClass} placeholder="Qual é a missão da sua ONG?"></textarea>
                    </div>
                    <div className={fieldWrapperClass}>
                        <label className={labelClass}>Website da Organização</label>
                        <input type="url" value={organizationWebsite} onChange={e => setOrganizationWebsite(e.target.value)} disabled={!isEditing} className={inputClass} placeholder="https://suaong.org"/>
                    </div>
                </>
            )}

            {isEditing && (
                <div className="flex justify-end space-x-3 mt-6">
                    <button onClick={() => setIsEditing(false)} className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancelar</button>
                    <button onClick={handleSaveProfile} disabled={loading} className="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md disabled:opacity-50">
                        {loading ? 'Salvando...' : 'Salvar Alterações'}
                    </button>
                </div>
            )}
        </div>
    );
};

const EventDetailsPage = ({ event, navigate }) => {
    if (!event) return <p>Evento não encontrado.</p>;

    return (
        <div className="bg-white p-6 sm:p-8 rounded-lg shadow-xl max-w-4xl mx-auto">
            <button onClick={() => navigate('home')} className="mb-6 text-blue-600 hover:text-blue-800 font-medium flex items-center">
                <ArrowLeft size={20} className="mr-1" /> Voltar para Início
            </button>
            
            <img 
                src={event.imageUrl || `https://placehold.co/800x300/7C3AED/FFFFFF?text=${encodeURIComponent(event.title.substring(0,20))}`} 
                alt={`Imagem para ${event.title}`} 
                className="w-full h-56 sm:h-72 object-cover rounded-lg mb-6 shadow-md"
                onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/800x300/CCCCCC/FFFFFF?text=Imagem+Indisponível`; }}
            />

            <h1 className="text-3xl sm:text-4xl font-bold text-indigo-700 mb-3">{event.title}</h1>
            <p className="text-gray-600 text-sm mb-1"><strong className="font-medium">Organizado por:</strong> {event.organizer}</p>
            
            <div className="grid md:grid-cols-2 gap-x-6 gap-y-3 my-6 text-sm">
                <InfoPill icon={<CalendarDays size={18} />} label="Data" value={event.date} />
                <InfoPill icon={<Clock size={18} />} label="Horário" value={event.time} />
                <InfoPill icon={<MapPin size={18} />} label="Local" value={event.location} />
            </div>

            <div className="mb-8">
                <h2 className="text-xl font-semibold text-gray-800 mb-2">Sobre o Evento</h2>
                <p className="text-gray-700 leading-relaxed whitespace-pre-wrap">{event.description}</p>
            </div>
            
            <button 
                onClick={() => navigate('eventRegistration', event)}
                className="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg text-lg shadow-md transition duration-150 flex items-center justify-center"
            >
                <Ticket size={20} className="mr-2" /> Inscrever-se neste Evento
            </button>
        </div>
    );
};

const EventRegistrationPage = ({ event, navigate, handleShowMessage }) => {
    const [name, setName] = useState('');
    const [email, setEmail] = useState('');
    const [phone, setPhone] = useState('');
    const [loading, setLoading] = useState(false);
    const { currentUser } = useAuth();

    useEffect(() => {
        if (currentUser) {
            setName(currentUser.displayName || '');
            setEmail(currentUser.email || '');
        }
    }, [currentUser]);

    const handleSubmit = (e) => {
        e.preventDefault();
        setLoading(true);
        // Simulate registration
        console.log('Event Registration Submitted:', { eventId: event.id, eventTitle: event.title, name, email, phone });
        setTimeout(() => {
            setLoading(false);
            handleShowMessage(`Inscrição para "${event.title}" realizada com sucesso! (Simulação)`, 'success', 7000);
            navigate('eventDetails', event); 
        }, 1500);
    };
    
    const inputClass = "w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:outline-none";
    const labelClass = "block text-sm font-medium text-gray-700 mb-1";

    if (!event) return <p>Evento não encontrado para inscrição.</p>;

    return (
        <div className="bg-white p-6 sm:p-8 rounded-lg shadow-xl max-w-lg mx-auto">
            <button onClick={() => navigate('eventDetails', event)} className="mb-6 text-blue-600 hover:text-blue-800 font-medium flex items-center">
                <ArrowLeft size={20} className="mr-1" /> Voltar para Detalhes do Evento
            </button>
            <div className="text-center mb-6">
                <ClipboardSignature size={48} className="text-red-500 mx-auto mb-3" />
                <h1 className="text-2xl sm:text-3xl font-bold text-gray-800">Inscrição: {event.title}</h1>
                <p className="text-sm text-gray-500 mt-1">Preencha seus dados para participar.</p>
            </div>

            <form onSubmit={handleSubmit} className="space-y-4">
                {event.registrationFields?.includes('Nome Completo') && (
                    <div>
                        <label htmlFor="regName" className={labelClass}>Nome Completo</label>
                        <input type="text" id="regName" value={name} onChange={e => setName(e.target.value)} required className={inputClass} />
                    </div>
                )}
                {event.registrationFields?.includes('Email') && (
                    <div>
                        <label htmlFor="regEmail" className={labelClass}>Email</label>
                        <input type="email" id="regEmail" value={email} onChange={e => setEmail(e.target.value)} required className={inputClass} />
                    </div>
                )}
                {event.registrationFields?.includes('Telefone (Opcional)') && (
                     <div>
                        <label htmlFor="regPhone" className={labelClass}>Telefone (Opcional)</label>
                        <input type="tel" id="regPhone" value={phone} onChange={e => setPhone(e.target.value)} className={inputClass} placeholder="(XX) XXXXX-XXXX"/>
                    </div>
                )}
                <button type="submit" disabled={loading} className="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-md transition duration-150 disabled:opacity-50 flex items-center justify-center">
                    {loading ? <div className="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div> : 'Confirmar Inscrição'}
                </button>
            </form>
        </div>
    );
};

const OpportunityApplicationPage = ({ opportunity, navigate, handleShowMessage }) => {
    const [applicationMessage, setApplicationMessage] = useState('');
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const { currentUser, userData } = useAuth();

    const handleSubmitApplication = async (e) => {
        e.preventDefault();
        setError('');

        if (!currentUser) {
            setError("Você precisa estar logado para se candidatar.");
            return;
        }
        if (userData?.role !== 'volunteer') {
            setError("Apenas voluntários podem se candidatar a oportunidades.");
            return;
        }

        setLoading(true);

        if (opportunity.id.startsWith('example-')) {
            console.log('Simulated Application:', { opportunityId: opportunity.id, volunteerId: currentUser.uid, message: applicationMessage });
            setTimeout(() => {
                setLoading(false);
                handleShowMessage(`Candidatura para "${opportunity.title}" enviada com sucesso! (Simulação)`, 'success', 7000);
                localStorage.setItem(`sim_app_${opportunity.id}_${currentUser.uid}`, 'applied'); 
                navigate('opportunityDetails', opportunity); 
            }, 1500);
            return;
        }

        try {
            const q = query(
                collection(db, `/artifacts/${appId}/public/data/applications`),
                where("volunteerId", "==", currentUser.uid),
                where("opportunityId", "==", opportunity.id)
            );
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                setError("Você já se candidatou para esta oportunidade.");
                setLoading(false);
                return;
            }

            const applicationsRef = collection(db, `/artifacts/${appId}/public/data/applications`);
            await addDoc(applicationsRef, {
                opportunityId: opportunity.id,
                opportunityTitle: opportunity.title,
                organizationId: opportunity.organizationId,
                organizationName: opportunity.organizationName,
                volunteerId: currentUser.uid,
                volunteerName: userData.name || currentUser.displayName,
                volunteerEmail: currentUser.email,
                applicationDate: Timestamp.now(),
                status: 'Pendente',
                messageToOrg: applicationMessage,
                messageFromOrg: ''
            });
            setLoading(false);
            handleShowMessage(`Candidatura para "${opportunity.title}" enviada com sucesso!`, 'success', 7000);
            navigate('opportunityDetails', opportunity); 
        } catch (err) {
            console.error("Error submitting application: ", err);
            setError("Erro ao enviar candidatura. Tente novamente.");
            setLoading(false);
        }
    };

    const inputClass = "w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:outline-none";
    const labelClass = "block text-sm font-medium text-gray-700 mb-1";

    if (!opportunity) return <p>Oportunidade não encontrada para candidatura.</p>;

    return (
        <div className="bg-white p-6 sm:p-8 rounded-lg shadow-xl max-w-lg mx-auto">
            <button onClick={() => navigate('opportunities')} className="mb-6 text-blue-600 hover:text-blue-800 font-medium flex items-center">
                <ArrowLeft size={20} className="mr-1" /> Voltar para Oportunidades
            </button>
            <div className="text-center mb-6">
                <FileText size={48} className="text-green-500 mx-auto mb-3" />
                <h1 className="text-2xl sm:text-3xl font-bold text-gray-800">Candidatar-se para:</h1>
                <p className="text-xl text-green-600 font-semibold">{opportunity.title}</p>
                <p className="text-sm text-gray-500 mt-1">Organização: {opportunity.organizationName}</p>
            </div>

            {error && <MessageBox message={error} type="error" onDismiss={() => setError('')} />}

            <form onSubmit={handleSubmitApplication} className="space-y-4">
                <div>
                    <label htmlFor="applicationMessage" className={labelClass}>
                        Mensagem para a organização (opcional):
                    </label>
                    <textarea
                        id="applicationMessage"
                        rows="4"
                        value={applicationMessage}
                        onChange={(e) => setApplicationMessage(e.target.value)}
                        className={inputClass}
                        placeholder="Deixe uma breve apresentação ou motivo do seu interesse..."
                    ></textarea>
                </div>
                <button type="submit" disabled={loading} className="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-md transition duration-150 disabled:opacity-50 flex items-center justify-center">
                    {loading ? <div className="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div> : 'Confirmar Inscrição'}
                </button>
            </form>
        </div>
    );
};

// Default export for the main App component wrapped with AuthProvider
export default function MainApp() {
    return (
        <AuthProvider>
            <App />
        </AuthProvider>
    );
}

